<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ì¶¤í˜• í˜‘ìƒ ì „ëµ ì‹œë®¬ë ˆì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+KR:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans KR', 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .dialogue-box {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 0.75rem;
        }
        .player-turn {
            background-color: #e0f2fe; /* Light blue */
            border-bottom-left-radius: 0 !important;
            border-top-right-radius: 0.75rem;
        }
        .opponent-turn {
            background-color: #fee2e2; /* Light red/pink */
            border-bottom-right-radius: 0 !important;
            border-top-left-radius: 0.75rem;
        }
        .input-group label {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
            display: block;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.15s;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <div id="app" class="bg-white shadow-2xl rounded-xl max-w-4xl w-full p-6 md:p-10 border-t-4 border-indigo-600">
        <h1 class="3xl font-bold text-gray-900 mb-2 text-center">ğŸ¤ ë§ì¶¤í˜• í˜‘ìƒ ì „ëµ ì‹œë®¬ë ˆì´í„°</h1>
        <p class="text-center text-sm text-gray-500 mb-6">ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì§ì ‘ ì„¤ì •í•˜ê³  í˜‘ìƒ ì´ë¡ ì„ ì ìš©í•´ ë³´ì„¸ìš”.</p>

        <!-- Configuration View -->
        <div id="config-view" class="space-y-6">
            <h2 class="text-xl font-semibold text-gray-700 border-b pb-2">ì‹œë‚˜ë¦¬ì˜¤ ì„¤ì •</h2>
            
            <div class="input-group">
                <label for="scenario-title">1. í˜‘ìƒ ì˜ì œ/ìƒí™© (ì˜ˆ: ë™ì•„ë¦¬ ê³µê°„ ë¶„ìŸ)</label>
                <input type="text" id="scenario-title" placeholder="í•„ìˆ˜: í˜‘ìƒí•  ì£¼ìš” ì•ˆê±´ì„ ì…ë ¥í•˜ì„¸ìš”." value="ê¸ˆìš”ì¼ ì €ë… ëŒ€ê°•ë‹¹ ì‚¬ìš©ê¶Œ">
            </div>

            <div class="grid md:grid-cols-2 gap-6">
                <!-- Player Config -->
                <div class="p-4 border border-indigo-200 rounded-lg bg-indigo-50 space-y-4">
                    <h3 class="font-bold text-lg text-indigo-700">ë‚˜ (í”Œë ˆì´ì–´) ì„¤ì •</h3>
                    <div class="input-group">
                        <label for="player-position">ì…ì¥ (Position)</label>
                        <input type="text" id="player-position" placeholder="ë‚´ê°€ ë“œëŸ¬ë‚¸ ìš”êµ¬ (ì˜ˆ: ê¸ˆìš”ì¼ ì €ë… ëŒ€ê°•ë‹¹ ì‚¬ìš©)" value="ê¸ˆìš”ì¼ ì €ë… ëŒ€ê°•ë‹¹ ì‚¬ìš©">
                    </div>
                    <div class="input-group">
                        <label for="player-motive">ë™ê¸° (Motive/ê·¼ì›ì  ì´í•´)</label>
                        <textarea id="player-motive" rows="2" placeholder="ì´ ì…ì¥ì„ ê°€ì§€ê²Œ ëœ ê·¼ë³¸ì ì¸ ì´ìœ  (ì˜ˆ: í™ë³´ë¥¼ ìœ„í•œ ê°€ì‹œì„± í™•ë³´)">ì‹ ì… ë¶€ì› ëª¨ì§‘ì„ ìœ„í•œ ê°€ì‹œì„±ì´ ë†’ì€ ë„“ì€ ê³µê°„ í•„ìš” (í™ë³´/ì„±ì¥)</textarea>
                    </div>
                    <div class="input-group">
                        <label for="player-batna">ë³µì•ˆ (BATNA)</label>
                        <input type="text" id="player-batna" placeholder="í•©ì˜ ê²°ë ¬ ì‹œ ìµœì„ ì˜ ëŒ€ì•ˆ (ì˜ˆ: ì§€í•˜ ì†Œê°•ì˜ì‹¤ ì‚¬ìš©)" value="ì§€í•˜ ì†Œê°•ì˜ì‹¤ ì‚¬ìš© (í™ë³´ íš¨ê³¼ ëŒ€í­ ê°ì†Œ)">
                    </div>
                </div>

                <!-- Opponent Config -->
                <div class="p-4 border border-red-200 rounded-lg bg-red-50 space-y-4">
                    <h3 class="font-bold text-lg text-red-700">ìƒëŒ€ë°© (Opponent) ì„¤ì •</h3>
                    <div class="input-group">
                        <label for="opponent-name">ìƒëŒ€ë°© ì´ë¦„/ë‹¨ì²´</label>
                        <input type="text" id="opponent-name" placeholder="ìƒëŒ€ë°©ì˜ ëª…ì¹­ (ì˜ˆ: í•„ë¦„ ë™ì•„ë¦¬ íšŒì¥)" value="ì˜ìƒ ì œì‘ ë™ì•„ë¦¬ 'í•„ë¦„' íšŒì¥">
                    </div>
                    <div class="input-group">
                        <label for="opponent-position">ì…ì¥ (Position)</label>
                        <input type="text" id="opponent-position" placeholder="ìƒëŒ€ë°©ì´ ë“œëŸ¬ë‚¸ ìš”êµ¬ (ì˜ˆ: ê¸ˆìš”ì¼ ì €ë… ëŒ€ê°•ë‹¹ ì‚¬ìš©)" value="ê¸ˆìš”ì¼ ì €ë… ëŒ€ê°•ë‹¹ ì‚¬ìš©">
                    </div>
                    <div class="input-group">
                        <label for="opponent-motive">ë™ê¸° (Motive/ê·¼ì›ì  ì´í•´)</label>
                        <textarea id="opponent-motive" rows="2" placeholder="ìƒëŒ€ë°©ì´ ì´ ì…ì¥ì„ ê°€ì§€ê²Œ ëœ ê·¼ë³¸ì ì¸ ì´ìœ  (ì˜ˆ: ì§‘ì¤‘ì„ ìœ„í•œ ë°©ìŒ ê³µê°„ í™•ë³´)">ì˜ìƒ ì´¬ì˜ ì‹œ ì†ŒìŒì´ ì—†ëŠ” ë„“ì€ ê³µê°„ì´ í•„ìˆ˜ì ì„ (ì§‘ì¤‘/ì™„ì„±ë„)</textarea>
                    </div>
                    <div class="input-group">
                        <label for="opponent-batna">ë³µì•ˆ (BATNA)</label>
                        <input type="text" id="opponent-batna" placeholder="í•©ì˜ ê²°ë ¬ ì‹œ ìƒëŒ€ì˜ ìµœì„ ì˜ ëŒ€ì•ˆ (ì˜ˆ: ì¼ë°˜ ê°•ì˜ì‹¤ ì‚¬ìš©)" value="ì¼ë°˜ ê°•ì˜ì‹¤ ì‚¬ìš© (ì´¬ì˜ êµ¬ë„ ë° ìŒí–¥ ë¬¸ì œ ì‹¬ê°)">
                    </div>
                </div>
            </div>

            <button onclick="startSimulation()" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-xl hover:bg-indigo-700 transition duration-200 shadow-md active:shadow-none active:translate-y-0.5">
                í˜‘ìƒ ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘
            </button>
        </div>

        <!-- Negotiation View (Hidden by default) -->
        <div id="negotiation-view" class="hidden">
            <!-- Scenario Description -->
            <div id="scenario-display" class="bg-indigo-50 border-l-4 border-indigo-400 p-4 rounded-lg mb-6">
                <!-- Content will be injected by startSimulation() -->
            </div>

            <!-- Dialogue Area -->
            <div id="dialogue" class="dialogue-box bg-gray-100 p-4 mb-6 space-y-3 shadow-inner">
                <!-- Initial Message will be added by startSimulation() -->
            </div>

            <!-- Action Area -->
            <div id="action-area" class="space-y-4">
                <textarea id="player-input" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="ì—¬ê¸°ì— ë‹¹ì‹ ì˜ ì œì•ˆì´ë‚˜ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
                
                <div class="grid grid-cols-2 gap-4">
                    <button id="propose-btn" onclick="handleNegotiation('propose')" class="bg-indigo-600 text-white font-semibold py-3 rounded-xl hover:bg-indigo-700 transition duration-200 shadow-md active:shadow-none active:translate-y-0.5">
                        ì œì•ˆ/ë°œì–¸í•˜ê¸° (ì…ë ¥ ë‚´ìš© ì œì¶œ)
                    </button>
                    <button onclick="handleNegotiation('end')" class="bg-red-500 text-white font-semibold py-3 rounded-xl hover:bg-red-600 transition duration-200 shadow-md active:shadow-none active:translate-y-0.5">
                        í˜‘ìƒ ì¢…ë£Œ ë° í•©ì˜ ì‹œë„
                    </button>
                </div>
                
                <div class="mt-4 border-t pt-4">
                    <p class="font-semibold text-gray-700 mb-2">ì „ëµì  ë°œì–¸ ì„ íƒ (ì´ë¡  ì ìš©):</p>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <button onclick="handleNegotiation('strategy', 'ask_motive')" class="strategy-btn bg-yellow-100 text-yellow-800 text-sm font-medium py-2 rounded-full hover:bg-yellow-200 transition duration-150 border border-yellow-300">
                            ë™ê¸°(ê·¼ì›ì  ì´í•´) ì§ˆë¬¸í•˜ê¸°
                        </button>
                        <button onclick="handleNegotiation('strategy', 'pie_enlargement')" class="strategy-btn bg-green-100 text-green-800 text-sm font-medium py-2 rounded-full hover:bg-green-200 transition duration-150 border border-green-300">
                            ì°½ì˜ì  ëŒ€ì•ˆ (íŒŒì´ í‚¤ìš°ê¸°)
                        </button>
                        <button onclick="handleNegotiation('strategy', 'objective_criteria')" class="strategy-btn bg-blue-100 text-blue-800 text-sm font-medium py-2 rounded-full hover:bg-blue-200 transition duration-150 border border-blue-300">
                            ê°ê´€ì  ê¸°ì¤€ ì œì‹œ
                        </button>
                        <button onclick="handleNegotiation('strategy', 'reveal_batna')" class="strategy-btn bg-purple-100 text-purple-800 text-sm font-medium py-2 rounded-full hover:bg-purple-200 transition duration-150 border border-purple-300">
                            BATNA ê°„ì ‘ ì•”ì‹œ
                        </button>
                    </div>
                </div>
            </div>
            <!-- Opponent Info Hint -->
            <p id="opponent_info_hint" class="mt-3 text-xs text-red-600 font-semibold hidden"></p>
        </div>


        <!-- Result Modal -->
        <div id="result-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50" onclick="closeModal()">
            <div class="bg-white rounded-xl max-w-2xl w-full p-8 shadow-2xl" onclick="event.stopPropagation()">
                <h2 id="result-title" class="text-3xl font-bold mb-4 text-center text-indigo-700">í˜‘ìƒ ê²°ê³¼</h2>
                <div id="result-content" class="text-gray-700 space-y-4">
                    <!-- Dynamic content will be inserted here -->
                </div>
                <button onclick="window.location.reload()" class="mt-6 w-full bg-indigo-600 text-white font-semibold py-3 rounded-xl hover:bg-indigo-700 transition duration-200">
                    ë‹¤ì‹œ ì‹œì‘í•˜ê¸°
                </button>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
            <div class="flex flex-col items-center p-5 bg-white rounded-lg shadow-xl">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-3 text-gray-700 font-medium">AI ìƒëŒ€ë°©ì´ ë‹µë³€ì„ ìƒì„±í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>
        </div>

    </div>

    <script>
        const dialogueEl = document.getElementById('dialogue');
        const inputEl = document.getElementById('player-input');
        const proposeBtnEl = document.getElementById('propose-btn');
        const loadingOverlayEl = document.getElementById('loading-overlay');
        const opponentInfoHintEl = document.getElementById('opponent_info_hint');
        const configViewEl = document.getElementById('config-view');
        const negotiationViewEl = document.getElementById('negotiation-view');
        const scenarioDisplayEl = document.getElementById('scenario-display');

        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        let SCENARIO = {}; // ì‚¬ìš©ì ì…ë ¥ìœ¼ë¡œ ì±„ì›Œì§ˆ ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„°

        // ====== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (API í˜¸ì¶œ ë° ë°±ì˜¤í”„) ======

        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429) { // 429: Too Many Requests (Retry)
                        return response;
                    }
                    // Handle 429: Wait before retrying
                } catch (error) {
                    // Handle network or other errors: Wait before retrying
                }

                if (i < maxRetries - 1) {
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await sleep(delay);
                }
            }
            throw new Error("API call failed after multiple retries.");
        }


        // ====== 1. ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘ ë° ì„¤ì • ì½ê¸° í•¨ìˆ˜ ======
        function startSimulation() {
            const title = document.getElementById('scenario-title').value.trim();
            const pPosition = document.getElementById('player-position').value.trim();
            const pMotive = document.getElementById('player-motive').value.trim();
            const pBatna = document.getElementById('player-batna').value.trim();
            const oName = document.getElementById('opponent-name').value.trim();
            const oPosition = document.getElementById('opponent-position').value.trim();
            const oMotive = document.getElementById('opponent-motive').value.trim();
            const oBatna = document.getElementById('opponent-batna').value.trim();

            if (!title || !pPosition || !pMotive || !oPosition || !oMotive || !oName) {
                // ì´ ê²½ê³  ë©”ì‹œì§€ëŠ” í•œêµ­ì–´ë¡œ ìœ ì§€
                alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©(ì˜ì œ, ì…ì¥, ë™ê¸°, ìƒëŒ€ë°© ì´ë¦„)ì„ ì…ë ¥í•´ì•¼ ì‹œë®¬ë ˆì´ì…˜ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            SCENARIO = {
                title: title,
                player: { position: pPosition, motive: pMotive, batna: pBatna },
                opponent: { name: oName, position: oPosition, motive: oMotive, batna: oBatna }
            };

            // UI ì „í™˜
            configViewEl.classList.add('hidden');
            negotiationViewEl.classList.remove('hidden');

            // ì‹œë‚˜ë¦¬ì˜¤ ë””ìŠ¤í”Œë ˆì´ ì—…ë°ì´íŠ¸
            scenarioDisplayEl.innerHTML = `
                <p class="font-semibold text-indigo-800 mb-2">ğŸ“Œ ì‹œë‚˜ë¦¬ì˜¤: ${SCENARIO.title}</p>
                <p class="text-sm text-indigo-700">
                    ë‹¹ì‹ ì€ **${SCENARIO.player.position}**ì„(ë¥¼) ì›í•˜ë©°, **${SCENARIO.opponent.name}**ì€(ëŠ”) **${SCENARIO.opponent.position}**ì„(ë¥¼) ì›í•©ë‹ˆë‹¤.
                </p>
                <div class="mt-3 text-xs text-indigo-600">
                    <p><strong>- ìš°ë¦¬ ì¸¡ ì…ì¥:</strong> ${SCENARIO.player.position}</p>
                    <p><strong>- ìš°ë¦¬ ì¸¡ ë™ê¸°:</strong> ${SCENARIO.player.motive}</p>
                    <p><strong>- ìš°ë¦¬ ì¸¡ BATNA:</strong> ${SCENARIO.player.batna || 'ì—†ìŒ'}</p>
                </div>
            `;

            // ì´ˆê¸° ëŒ€í™” ì‹œì‘
            addDialogue('opponent', `ì•ˆë…•í•˜ì„¸ìš”. ${SCENARIO.opponent.name}ì…ë‹ˆë‹¤. ì €í¬ì˜ ì…ì¥(Position)ì€ **${SCENARIO.opponent.position}**ì…ë‹ˆë‹¤. ê·€ì¸¡ì˜ ì…ì¥ì„ ë¨¼ì € ë§ì”€í•´ ì£¼ì‹œê² ì–´ìš”?`);
        }


        // ====== 2. ê²Œì„ ìƒíƒœ ë° í‰ê°€ ë³€ìˆ˜ ======
        let gameState = {
            turn: 0,
            dialogues: [],
            baseScore: 0, // ê¸°ë³¸ ì ìˆ˜ (ìµœëŒ€ 100ì  + ì „ëµ ë³´ë„ˆìŠ¤)
            strategyUsed: {
                ask_motive: 0, 
                pie_enlargement: 0, 
                objective_criteria: 0, 
                reveal_batna: 0, 
            },
            opponentMotiveRevealed: false,
            negotiationEndReason: null, // 'mutual_gain', 'compromise', 'win_lose', 'breakdown'
            lastPlayerInput: '', // ìµœì¢… í”¼ë“œë°±ì„ ìœ„í•œ ë§ˆì§€ë§‰ í”Œë ˆì´ì–´ ì…ë ¥ ì €ì¥
        };

        // ====== 3. UI ë Œë”ë§ í•¨ìˆ˜ ======

        function addDialogue(sender, message, isStrategy = false) {
            const dialogueItem = document.createElement('div');
            
            // Sender-specific styling
            if (sender === 'player') {
                dialogueItem.className = 'player-turn ml-auto w-11/12';
                message = `<span class="font-bold text-indigo-700">ë‚˜:</span> ${message}`;
            } else if (sender === 'opponent') {
                dialogueItem.className = 'opponent-turn mr-auto w-11/12';
                message = `<span class="font-bold text-red-700">${SCENARIO.opponent.name}:</span> ${message}`;
            } else { // System/Hint message
                dialogueItem.className = 'bg-gray-200 mr-auto w-11/12';
                message = `<span class="font-bold text-gray-700">${message}</span>`;
            }
            
            dialogueItem.className += ' p-3 rounded-xl shadow-md transition duration-300 text-gray-800 space-y-1';

            dialogueItem.innerHTML = message;

            dialogueEl.appendChild(dialogueItem);
            dialogueEl.scrollTop = dialogueEl.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
        }
        
        // ====== 4. LLM ê¸°ë°˜ ë™ì  ì‘ë‹µ ìƒì„± í•¨ìˆ˜ ======

        async function generateAiResponse(playerText) {
            
            const systemPrompt = `
                ë‹¹ì‹ ì€ í˜‘ìƒ ì‹œë®¬ë ˆì´ì…˜ì˜ ìƒëŒ€ë°©ì¸ '${SCENARIO.opponent.name}'ì…ë‹ˆë‹¤.
                ë‹¹ì‹ ì˜ ì—­í• ì€ ì‚¬ìš©ìê°€ í˜‘ìƒ ì „ëµ(ë™ê¸° íŒŒì•…, ì°½ì˜ì  ëŒ€ì•ˆ ë“±)ì„ ì‚¬ìš©í•˜ë„ë¡ ìœ ë„í•˜ë©´ì„œ, ë‹¹ì‹ ì˜ ì…ì¥ê³¼ ë™ê¸°ë¥¼ ì§€í‚¤ëŠ” ê²ƒì…ë‹ˆë‹¤.
                
                # í˜‘ìƒ ìƒí™©
                - ì˜ì œ: ${SCENARIO.title}
                - ë‹¹ì‹ ì˜ ì…ì¥(Position): ${SCENARIO.opponent.position}
                - ë‹¹ì‹ ì˜ ë™ê¸°(Motive/ê·¼ì›ì  ì´í•´): ${SCENARIO.opponent.motive}
                - ìƒëŒ€ë°©ì˜ ì…ì¥(Position): ${SCENARIO.player.position}
                - ìƒëŒ€ë°©ì˜ ë™ê¸°(Motive/ê·¼ì›ì  ì´í•´): ${SCENARIO.player.motive} (ì°¸ê³ ë§Œ í•˜ì„¸ìš”)
                
                # í˜„ì¬ í˜‘ìƒ ìƒíƒœ
                - ìƒëŒ€ë°©ì´ ë‹¹ì‹ ì˜ ë™ê¸°ë¥¼ ë…¸ì¶œì‹œì¼°ëŠ”ì§€(opponentMotiveRevealed): ${gameState.opponentMotiveRevealed ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}

                # ì§€ì¹¨
                1. í•œêµ­ì–´ë¡œ ìì—°ìŠ¤ëŸ½ê³  ì •ì¤‘í•˜ê²Œ ë‹µë³€í•˜ì‹­ì‹œì˜¤.
                2. ë‹¹ì‹ ì˜ ì…ì¥(${SCENARIO.opponent.position})ì„ ê´€ì² í•˜ë ¤ê³  ë…¸ë ¥í•˜ë˜, **í˜¸í˜œì  í•©ì˜**ë¥¼ ëª©í‘œë¡œ í•œë‹¤ëŠ” í†¤ì„ ìœ ì§€í•˜ì‹­ì‹œì˜¤.
                3. ìƒëŒ€ë°©ì˜ ì œì•ˆì´ ë‹¹ì‹ ì˜ ë™ê¸°(${SCENARIO.opponent.motive})ë¥¼ ì¶©ì¡±ì‹œí‚¤ëŠ”ì§€ í•­ìƒ ê³ ë ¤í•˜ì‹­ì‹œì˜¤.
                4. ë§Œì•½ ìƒëŒ€ë°©ì´ ë‹¹ì‹ ì˜ ë™ê¸°ë¥¼ ë¬»ëŠ”ë‹¤ë©´(ì˜ˆ: ì™œ ì¤‘ìš”í•œê°€ìš”?), ë™ê¸°(${SCENARIO.opponent.motive})ë¥¼ ê°„ì ‘ì ì´ê±°ë‚˜ ë¶€ë¶„ì ìœ¼ë¡œ ì–¸ê¸‰í•˜ë©° ë‹µë³€í•˜ì‹­ì‹œì˜¤.
                5. ë‹µë³€ì€ ê°„ê²°í•˜ê²Œ í•œë‘ ë¬¸ë‹¨ìœ¼ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.
            `;
            
            const userQuery = `ë‹¤ìŒì€ ì‚¬ìš©ì(í”Œë ˆì´ì–´)ì˜ ë§ˆì§€ë§‰ ë°œì–¸ì…ë‹ˆë‹¤. ì´ ë°œì–¸ì— ëŒ€í•´ ì‘ë‹µí•˜ì‹­ì‹œì˜¤: "${playerText}"`;
            
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                loadingOverlayEl.classList.remove('hidden');
                
                const response = await exponentialBackoffFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "ì£„ì†¡í•©ë‹ˆë‹¤. AI ìƒëŒ€ë°©ì˜ ì‘ë‹µ ìƒì„±ì— ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë°©ì‹ìœ¼ë¡œ ì§ˆë¬¸í•´ì£¼ì‹œê² ì–´ìš”?";
                
                loadingOverlayEl.classList.add('hidden');
                return text;

            } catch (error) {
                console.error("Gemini API call error:", error);
                loadingOverlayEl.classList.add('hidden');
                return "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” API í˜¸ì¶œ ì‹¤íŒ¨ë¡œ ì¸í•´ AI ìƒëŒ€ë°©ì˜ ì‘ë‹µ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
            }
        }


        // ====== 5. í˜‘ìƒ ë¡œì§ (í•µì‹¬) ======

        async function handleNegotiation(actionType, strategyKey = null) {
            proposeBtnEl.disabled = true; // ë²„íŠ¼ ë¹„í™œì„±í™” (API ì‘ë‹µ ì¤‘ë³µ ë°©ì§€)

            if (actionType === 'propose') {
                const text = inputEl.value.trim();
                if (!text) {
                    proposeBtnEl.disabled = false;
                    return;
                }
                
                // 1. í”Œë ˆì´ì–´ ë°œì–¸ ì¶”ê°€
                addDialogue('player', text);
                gameState.lastPlayerInput = text; // ë§ˆì§€ë§‰ ì…ë ¥ ì €ì¥
                inputEl.value = '';
                
                // 2. ìƒëŒ€ë°© ë°˜ì‘ ì²˜ë¦¬
                await processOpponentResponse(text);

            } else if (actionType === 'strategy' && strategyKey) {
                
                // 1. ì „ëµ ì‚¬ìš© íšŸìˆ˜ ê¸°ë¡ (ì ìˆ˜ ë¶€ì—¬ëŠ” ì—¬ê¸°ì„œ ì§„í–‰)
                gameState.strategyUsed[strategyKey]++;
                
                let hintMessage = '';

                switch (strategyKey) {
                    case 'ask_motive':
                        hintMessage = `ğŸ’¡ <strong>íŒíŠ¸: ë™ê¸° ì ‘ëª© ì „ëµ.</strong> ìƒëŒ€ë°©ì˜ ì…ì¥ì„ ì§ì ‘ì ìœ¼ë¡œ ê³µê²©í•˜ì§€ ë§ê³ , 'ì™œ' ê·¸ë“¤ì´ ê·¸ ì…ì¥ì„ ê°€ì§€ê²Œ ë˜ì—ˆëŠ”ì§€ **ë™ê¸°(Motive)**ë¥¼ íŒŒì•…í•˜ëŠ” ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: "ê·¸ ìš”êµ¬ê°€ ê·€ì¸¡ì— ì™œ ê°€ì¥ ì¤‘ìš”í•©ë‹ˆê¹Œ?")`;
                        
                        // ë™ê¸° íŒŒì•… ì„±ê³µ ì²˜ë¦¬ (ì ìˆ˜ ë¶€ì—¬)
                        if (!gameState.opponentMotiveRevealed) {
                            gameState.opponentMotiveRevealed = true;
                            opponentInfoHintEl.classList.remove('hidden');
                            opponentInfoHintEl.innerHTML = `âš ï¸ ìƒëŒ€ë°© ë™ê¸°(Motive) íŒíŠ¸ ê³µê°œ: **${SCENARIO.opponent.motive}** ì…ë‹ˆë‹¤. ì´ì œ ì´ ë™ê¸°ë¥¼ í™œìš©í•˜ì—¬ ì°½ì˜ì ì¸ ëŒ€ì•ˆì„ ëª¨ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì ìˆ˜ +30)`;
                            gameState.baseScore += 30; 
                        }
                        break;
                    case 'pie_enlargement':
                        hintMessage = `ğŸ’¡ <strong>íŒíŠ¸: íŒŒì´ í‚¤ìš°ê¸° ì „ëµ.</strong> ìƒëŒ€ë°©ì˜ ë™ê¸°(${SCENARIO.opponent.motive})ì™€ ë‚˜ì˜ ë™ê¸°(${SCENARIO.player.motive})ë¥¼ ëª¨ë‘ ë§Œì¡±ì‹œí‚¬ ìˆ˜ ìˆëŠ” **ìƒˆë¡œìš´ ìì›(ì‹œê°„, ê³µê°„ ë“±)ì´ë‚˜ ëŒ€ì•ˆ**ì„ êµ¬ì²´ì ìœ¼ë¡œ ì œì‹œí•´ì•¼ í•©ë‹ˆë‹¤.`;
                        if (gameState.strategyUsed.pie_enlargement === 1) gameState.baseScore += 50; 
                        else gameState.baseScore += 10;
                        gameState.negotiationEndReason = 'mutual_gain'; // íŒŒì´ í‚¤ìš°ê¸° ì „ëµì„ ì‚¬ìš©í•˜ë©´ í˜¸í˜œì  í•©ì˜ íŠ¸ë™ìœ¼ë¡œ ìœ ë„
                        break;
                    case 'objective_criteria':
                        hintMessage = "ğŸ’¡ <strong>íŒíŠ¸: ê°ê´€ì  ê¸°ì¤€ ì œì‹œ ì „ëµ.</strong> ê°ì •ì ì¸ ì£¼ì¥ ëŒ€ì‹ , í•©ì˜ì˜ ì •ë‹¹ì„±ì„ í™•ë³´í•˜ê¸° ìœ„í•´ 'ê°ê´€ì  ê¸°ì¤€'(ì˜ˆ: í•™êµ ê·œì •, ê³¼ê±° ì„ ë¡€, ì „ë¬¸ê°€ ì˜ê²¬)ì„ ë”°ë¥´ìê³  ì œì•ˆí•˜ì„¸ìš”.";
                        gameState.baseScore += 10;
                        break;
                    case 'reveal_batna':
                        hintMessage = `ğŸ’¡ <strong>íŒíŠ¸: BATNA ê°„ì ‘ ì•”ì‹œ ì „ëµ.</strong> í˜‘ìƒ ê²°ë ¬ ì‹œ ìš°ë¦¬ ì¸¡ì˜ ë³µì•ˆ(${SCENARIO.player.batna || 'ì°¨ì„ ì±…'})ì´ ë¶ˆë¦¬í•˜ì§€ ì•ŠìŒì„ ê°„ì ‘ì ìœ¼ë¡œ ì–¸ê¸‰í•˜ì—¬ í˜‘ìƒì˜ ì§€ë ›ëŒ€ë¡œ í™œìš©í•´ì•¼ í•©ë‹ˆë‹¤.`;
                        gameState.baseScore += 10;
                        break;
                }
                
                // 2. íŒíŠ¸ ë©”ì‹œì§€ ì¶œë ¥
                addDialogue('system', hintMessage);

            } else if (actionType === 'end') {
                showResult();
            }
            gameState.turn++;
            proposeBtnEl.disabled = false; // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
        }

        async function processOpponentResponse(playerText) {
            
            const lowerText = playerText.toLowerCase();

            let opponentResponse = null;

            // 1. **í•µì‹¬ ì „ëµ í‚¤ì›Œë“œ ê°ì§€ (ì ìˆ˜ ë° ìƒíƒœ ë³€ê²½ì„ ìœ„í•´ ê³ ì • ë¡œì§ ìœ ì§€)**
            
            // 1-1. ë™ê¸° íŒŒì•… ì‹œë„ (ê°€ì¥ ì¤‘ìš”í•œ ê¸ì •ì  í–‰ë™)
            if (lowerText.includes('ì™œ ì¤‘ìš”') || lowerText.includes('ì´ìœ ê°€ ë¬´ì—‡') || lowerText.includes('ê·¼ë³¸ì ì¸')) {
                if (!gameState.opponentMotiveRevealed) {
                    gameState.opponentMotiveRevealed = true;
                    opponentInfoHintEl.classList.remove('hidden');
                    opponentInfoHintEl.innerHTML = `âš ï¸ ìƒëŒ€ë°© ë™ê¸°(Motive) íŒíŠ¸ ê³µê°œ: **${SCENARIO.opponent.motive}** ì…ë‹ˆë‹¤. ì´ì œ ì´ ë™ê¸°ë¥¼ í™œìš©í•˜ì—¬ ì°½ì˜ì ì¸ ëŒ€ì•ˆì„ ëª¨ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì ìˆ˜ +30)`;
                    gameState.baseScore += 30; 
                    opponentResponse = `ê·€ì¸¡ì˜ ê¹Šì€ ì§ˆë¬¸ì— ê°ì‚¬ë“œë¦½ë‹ˆë‹¤. ì €í¬ê°€ ${SCENARIO.opponent.position}ì„(ë¥¼) ìš”êµ¬í•˜ëŠ” ê·¼ë³¸ì ì¸ ì´ìœ ëŠ” **${SCENARIO.opponent.motive}** ë•Œë¬¸ì…ë‹ˆë‹¤.`;
                }
                // ë™ê¸°ê°€ ì´ë¯¸ ë…¸ì¶œë˜ì—ˆë‹¤ë©´, LLMì—ê²Œ ë„˜ê²¨ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ë¥¼ ìœ ë„í•©ë‹ˆë‹¤.
            }
            
            // 1-2. ìƒí˜¸ ì–‘ë³´/íƒ€í˜‘ ì‹œë„
            else if (lowerText.includes('ì–‘ë³´') || lowerText.includes('ë‚˜ëˆ ') || lowerText.includes('íƒ€í˜‘') || lowerText.includes('ì ˆë°˜')) {
                gameState.negotiationEndReason = 'compromise';
                // LLMì—ê²Œ ë„˜ê²¨ ìì—°ìŠ¤ëŸ¬ìš´ ì‘ë‹µì„ ë°›ë˜, í˜‘ìƒ ê²°ë¡  íŠ¸ë™ì„ì„ AIì—ê²Œ ì•Œë ¤ì¤ë‹ˆë‹¤.
            }

            // 1-3. BATNA/ê°ê´€ì  ê¸°ì¤€ ì–¸ê¸‰ (í˜‘ìƒì˜ ì§€ë ›ëŒ€/ì •ë‹¹ì„±)
            else if (lowerText.includes('batna') || lowerText.includes('ë³µì•ˆ') || lowerText.includes('ê·œì •') || lowerText.includes('ì„ ë¡€') || lowerText.includes('ê¸°ì¤€') || lowerText.includes('ê°ê´€ì ')) {
                // LLMì—ê²Œ ë„˜ê²¨ ìì—°ìŠ¤ëŸ¬ìš´ ì‘ë‹µì„ ë°›ìŠµë‹ˆë‹¤.
            }
            
            // 1-4. ì°½ì˜ì  ëŒ€ì•ˆ ì œì‹œ (Win-Win ìœ ë„)
            else if (lowerText.includes('ìƒˆë¡œìš´ ëŒ€ì•ˆ') || lowerText.includes('ë‘˜ ë‹¤ ë§Œì¡±') || lowerText.includes('íŒŒì´ í‚¤ìš°ê¸°') || lowerText.includes('í†µí•©ì ') || lowerText.includes('ì°½ì˜ì ')) {
                gameState.negotiationEndReason = 'mutual_gain';
                // LLMì—ê²Œ ë„˜ê²¨ ìì—°ìŠ¤ëŸ¬ìš´ ì‘ë‹µì„ ë°›ë˜, í˜‘ìƒ ê²°ë¡  íŠ¸ë™ì„ì„ AIì—ê²Œ ì•Œë ¤ì¤ë‹ˆë‹¤.
            }
            
            // 2. **LLMì—ê²Œ ë™ì  ì‘ë‹µ ìš”ì²­**
            if (opponentResponse === null) {
                opponentResponse = await generateAiResponse(playerText);
            }
            
            // 3. AI ì‘ë‹µ ì¶”ê°€
            addDialogue('opponent', opponentResponse);
        }

        // ====== 6. ê²°ê³¼ ë° í‰ê°€ í•¨ìˆ˜ ======

        // ìµœì¢… ë°œì–¸ í”¼ë“œë°± ìƒì„± í•¨ìˆ˜
        function getFeedbackOnInput(text, reason) {
            const lowerText = text.toLowerCase();
            let feedback = "ê·€í•˜ì˜ ë°œì–¸ì€ í˜‘ìƒì˜ íë¦„ì„ ì›ë§Œí•˜ê²Œ ìœ ì§€í•˜ëŠ” ë° ê¸°ì—¬í–ˆìŠµë‹ˆë‹¤. (ì¼ë°˜ì ì¸ ë°œì–¸)";

            if (reason === 'mutual_gain') {
                if (lowerText.includes('ìƒˆë¡œìš´ ëŒ€ì•ˆ') || lowerText.includes('ë‘˜ ë‹¤ ë§Œì¡±') || lowerText.includes('íŒŒì´ í‚¤ìš°ê¸°') || lowerText.includes('ì°½ì˜ì ') || lowerText.includes('í†µí•©ì ')) {
                    feedback = "ë§ˆì§€ë§‰ ë°œì–¸ì—ì„œ **'í†µí•©ì  í˜‘ìƒ'**ì˜ í•µì‹¬ì¸ ì°½ì˜ì  ëŒ€ì•ˆì„ íš¨ê³¼ì ìœ¼ë¡œ ì œì‹œí•˜ì—¬ í˜¸í˜œì  í•©ì˜ë¥¼ ì´ëŒì–´ëƒˆìŠµë‹ˆë‹¤. í›Œë¥­í•©ë‹ˆë‹¤! ì–‘ì¸¡ì˜ ë™ê¸° ì¶©ì¡±ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.";
                } else {
                    feedback = "í˜¸í˜œì  í•©ì˜ì— ë„ë‹¬í–ˆìœ¼ë‚˜, ë§ˆì§€ë§‰ ë°œì–¸ì€ ë‹¤ì†Œ ì¼ë°˜ì ì´ì—ˆìŠµë‹ˆë‹¤. êµ¬ì²´ì ì¸ 'íŒŒì´ í‚¤ìš°ê¸°' ì•„ì´ë””ì–´ë¥¼ ì œì‹œí–ˆë‹¤ë©´ ë”ìš± ì¢‹ì•˜ì„ ê²ƒì…ë‹ˆë‹¤.";
                }
            } else if (reason === 'compromise') {
                 if (lowerText.includes('ì–‘ë³´') || lowerText.includes('ë‚˜ëˆ ') || lowerText.includes('ì ˆë°˜') || lowerText.includes('íƒ€í˜‘')) {
                    feedback = "ë§ˆì§€ë§‰ ë°œì–¸ì—ì„œ **'ìƒí˜¸ ì–‘ë³´ ì „ëµ'**ì„ ëª…í™•íˆ ì œì‹œí•˜ì—¬ êµì°© ìƒíƒœë¥¼ í•´ì†Œí•˜ê³  í•©ì˜ì— ì´ë¥´ë €ìŠµë‹ˆë‹¤. ì‹¤ìš©ì ì´ë©° ê´€ê³„ë¥¼ ìœ ì§€í•˜ëŠ” ì¢‹ì€ ì ‘ê·¼ì´ì—ˆìŠµë‹ˆë‹¤.";
                } else if (lowerText.includes(SCENARIO.player.position.toLowerCase())) {
                    feedback = "í˜‘ìƒì€ ìƒí˜¸ ì–‘ë³´ë¡œ ë§ˆë¬´ë¦¬ë˜ì—ˆìœ¼ë‚˜, ë§ˆì§€ë§‰ ë°œì–¸ì€ ì—¬ì „íˆ **'ì…ì¥ ê³ ìˆ˜'**ì— ì¹˜ìš°ì³¤ìŠµë‹ˆë‹¤. í•©ì˜ì ì„ ë” ë¶€ë“œëŸ½ê²Œ ì œì‹œí•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.";
                } else {
                    feedback = "ìƒí˜¸ ì–‘ë³´ë¡œ ëë‚¬ìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ ë°œì–¸ì€ ëŒ€í™”ì˜ ì¢…ë£Œë¥¼ ì•Œë¦¬ëŠ” ì—­í• ë§Œ í–ˆìœ¼ë©°, í•©ì˜ ë‚´ìš©ì„ ì •ë¦¬í•˜ëŠ” ë°œì–¸ì„ í–ˆë‹¤ë©´ ë” ì¢‹ì•˜ì„ ê²ƒì…ë‹ˆë‹¤.";
                }
            } else if (reason === 'breakdown') {
                if (lowerText.includes(SCENARIO.player.position.toLowerCase()) || lowerText.includes('í•´ì•¼ í•©ë‹ˆë‹¤')) {
                    feedback = "í˜‘ìƒ ê²°ë ¬ì˜ ì›ì¸ ì¤‘ í•˜ë‚˜ëŠ” **'ì…ì¥ ê³ ìˆ˜'**ì˜€ìŠµë‹ˆë‹¤. ë§ˆì§€ë§‰ê¹Œì§€ ìƒëŒ€ë°©ì˜ ë™ê¸°ë¥¼ ì´í•´í•˜ë ¤ëŠ” ë…¸ë ¥ì´ ë¶€ì¡±í–ˆìŠµë‹ˆë‹¤.";
                } else if (lowerText.includes('ê°ì •ì ') || lowerText.includes('ë¹„ë‚œ')) {
                    feedback = "í˜‘ìƒ ë§‰ë°”ì§€ì— ê°ì •ì ì¸ ì–¸ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ ê´€ê³„ë¥¼ ì•…í™”ì‹œí‚¤ê³  ê²°ë ¬ì„ ë§‰ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê°ê´€ì„±ì„ ìœ ì§€í•´ì•¼ í•©ë‹ˆë‹¤.";
                } else {
                    feedback = "í˜‘ìƒì„ ê²°ë ¬ì‹œí‚¨ ë§ˆì§€ë§‰ ë°œì–¸ì€ êµ¬ì²´ì ì¸ ëŒ€ì•ˆì´ ë¶€ì¡±í–ˆìŠµë‹ˆë‹¤. ë³µì•ˆ(BATNA)ì„ í™œìš©í• ì§€, ì•„ë‹ˆë©´ ì–‘ë³´í• ì§€ ëª…í™•í•œ ì „ëµ ì œì‹œê°€ í•„ìš”í–ˆìŠµë‹ˆë‹¤.";
                }
            }
            return feedback;
        }

        function showResult() {
            // í˜‘ìƒ ì¢…ë£Œ ì²˜ë¦¬
            let finalScore = gameState.baseScore;
            let finalAgreement = '';
            let achievementLevel = '';
            let strategyBonus = 0;
            const resultContentEl = document.getElementById('result-content');
            resultContentEl.innerHTML = '';
            
            // 1. ì „ëµ ë³´ë„ˆìŠ¤ ê³„ì‚° (ìµœëŒ€ 200ì )
            if (gameState.strategyUsed.ask_motive > 0) strategyBonus += 50; 
            if (gameState.strategyUsed.pie_enlargement > 0) strategyBonus += 100; 
            if (gameState.strategyUsed.objective_criteria > 0) strategyBonus += 20;
            if (gameState.strategyUsed.reveal_batna > 0) strategyBonus += 30;

            finalScore += strategyBonus;

            // 2. ìµœì¢… í•©ì˜ì•ˆ ê²°ì • (ZOPA ì˜ì—­ íŒë‹¨)
            if (gameState.negotiationEndReason === 'mutual_gain' && finalScore >= 180) {
                // í˜‘ë™ ì „ëµ (ì„±ê³¼â†‘ ê´€ê³„â†‘) - WIn-Win
                finalAgreement = `ì–‘ì¸¡ì˜ ê·¼ì›ì  ë™ê¸°(${SCENARIO.player.motive}ì™€ ${SCENARIO.opponent.motive})ë¥¼ ëª¨ë‘ ì¶©ì¡±ì‹œí‚¤ëŠ” ì°½ì˜ì ì¸ ëŒ€ì•ˆì„ ë„ì¶œí•˜ì—¬ í•©ì˜í–ˆìŠµë‹ˆë‹¤. (ì˜ˆ: ì‹œê°„ì„ ìª¼ê°œê±°ë‚˜, ìƒˆë¡œìš´ ìì›(ê³µê°„/ì‹œê°„)ì„ í™•ë³´)`;
                achievementLevel = 'í˜¸í˜œì  í˜‘ìƒ ë§ˆìŠ¤í„° (S)';
                finalScore += 50; 
            } else if (gameState.negotiationEndReason === 'compromise' && finalScore >= 100) {
                // ìƒí˜¸ ì–‘ë³´ ì „ëµ (ì„±ê³¼ â†” ê´€ê³„ â†”) - Compromise
                finalAgreement = `ì…ì¥(${SCENARIO.player.position}ê³¼ ${SCENARIO.opponent.position})ì„ ì‹œê°„ì´ë‚˜ ê³µê°„ì„ ë¶„í• í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ìƒí˜¸ ì–‘ë³´í•˜ì—¬ í•©ì˜í–ˆìŠµë‹ˆë‹¤. (ì˜ˆ: ì¼ì£¼ì¼ì”© ë²ˆê°ˆì•„ ì‚¬ìš©)`;
                achievementLevel = 'í†µí•©ì  í˜‘ìƒê°€ (A)';
            } else if (finalScore >= 50 && gameState.strategyUsed.reveal_batna > 0) {
                // íˆ¬ìŸ ì „ëµ ë˜ëŠ” ë‹¨ìˆœ íƒ€í˜‘ (ì„±ê³¼ â†‘ or â†“, ê´€ê³„ â†“) - Win-Lose
                finalAgreement = `ê·€ì¸¡ì˜ ë³µì•ˆ(${SCENARIO.opponent.batna || 'ìƒëŒ€ ë³µì•ˆ'})ê³¼ ìš°ë¦¬ ì¸¡ì˜ ë³µì•ˆ(${SCENARIO.player.batna || 'ìš°ë¦¬ ë³µì•ˆ'}) ì¤‘ ëœ ë¶ˆë¦¬í•œ ìª½ì„ ì„ íƒí•˜ê±°ë‚˜, í¬ê¸°ì— ëŒ€í•œ ë³´ìƒì„ ë°›ëŠ” ì„ ì—ì„œ í•©ì˜í–ˆìŠµë‹ˆë‹¤.`;
                achievementLevel = 'ë‹¨ê¸°ì  ì´ìµ ì¶”êµ¬ (B)';
            } else {
                // íšŒí”¼/íŒŒêµ­ ì „ëµ (ì„±ê³¼â†“ ê´€ê³„â†“) - Breakdown
                finalAgreement = `í•©ì˜ì— ì´ë¥´ì§€ ëª»í•˜ê³  í˜‘ìƒì´ íŒŒêµ­ì— ì´ë¥´ë €ìŠµë‹ˆë‹¤. ì–‘ì¸¡ ëª¨ë‘ ë¶ˆë¦¬í•œ ë³µì•ˆ(${SCENARIO.player.batna || 'ìš°ë¦¬ ë³µì•ˆ'}, ${SCENARIO.opponent.batna || 'ìƒëŒ€ ë³µì•ˆ'})ì„ ê°•ì œë¡œ ì´í–‰í•´ì•¼ í•©ë‹ˆë‹¤.`;
                achievementLevel = 'í˜‘ìƒ ì‹¤íŒ¨ (F)';
                finalScore = 0;
            }

            // 3. ê²°ê³¼ ëª¨ë‹¬ ë‚´ìš© êµ¬ì„±
            const totalScore = Math.min(Math.round(finalScore), 300); // ì ìˆ˜ ìƒí•œì„  300
            const finalInputFeedback = getFeedbackOnInput(gameState.lastPlayerInput, gameState.negotiationEndReason || 'breakdown'); // ì¢…ë£Œ ì‚¬ìœ ê°€ ì—†ìœ¼ë©´ ê²°ë ¬ë¡œ ê°„ì£¼
            
            resultContentEl.innerHTML += `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="font-bold text-xl text-indigo-600 mb-2">ğŸ† ìµœì¢… ì„±ì·¨ë„: ${achievementLevel}</h3>
                    <p class="text-3xl font-extrabold text-center text-red-500 my-4">${totalScore}ì  / 300ì </p>
                </div>

                <div class="space-y-2">
                    <p><strong class="text-indigo-600">í˜‘ìƒ ì˜ì œ:</strong> ${SCENARIO.title}</p>
                    <p><strong class="text-indigo-600">ìµœì¢… í•©ì˜ì•ˆ:</strong> ${finalAgreement}</p>
                </div>
                
                <h3 class="font-bold text-lg text-gray-800 mt-4 border-b pb-1">ğŸ—£ï¸ ìµœì¢… ë°œì–¸ì— ëŒ€í•œ í”¼ë“œë°±</h3>
                <p class="p-3 bg-yellow-50 rounded-lg text-sm italic border-l-4 border-yellow-400">${finalInputFeedback}</p>

                <h3 class="font-bold text-lg text-gray-800 mt-4 border-b pb-1">ì´ë¡  ê¸°ë°˜ í‰ê°€</h3>
                <ul class="list-disc pl-5 text-sm space-y-2">
                    <li class="${gameState.opponentMotiveRevealed ? 'text-green-700' : 'text-red-500'}">
                        <strong>ë™ê¸°(ê·¼ì›ì  ì´í•´) íŒŒì•…:</strong> ${gameState.opponentMotiveRevealed ? 'ì„±ê³µ (ìƒëŒ€ ë™ê¸° íŒŒì•… ì™„ë£Œ: ' + SCENARIO.opponent.motive + ')' : 'ë¯¸í¡ (í‘œë©´ì  ì…ì¥(Position)ì—ë§Œ ì§‘ì¤‘)'}
                    </li>
                    <li class="${gameState.strategyUsed.pie_enlargement > 0 ? 'text-green-700' : 'text-red-500'}">
                        <strong>ì°½ì˜ì  ëŒ€ì•ˆ(íŒŒì´ í‚¤ìš°ê¸°):</strong> ${gameState.strategyUsed.pie_enlargement > 0 ? 'ì ê·¹ì  í™œìš© (ìì› í™•ëŒ€ ì‹œë„)' : 'í™œìš© ë¶€ì¡± (ì œë¡œì„¬ ê²Œì„ì— ë¨¸ë¬´ë¦„)'}
                    </li>
                    <li class="${gameState.strategyUsed.objective_criteria > 0 ? 'text-green-700' : 'text-red-500'}">
                        <strong>ê°ê´€ì  ê¸°ì¤€ ì œì‹œ:</strong> ${gameState.strategyUsed.objective_criteria > 0 ? 'ì ì ˆíˆ í™œìš© (í•©ì˜ì˜ ì •ë‹¹ì„± í™•ë³´)' : 'í™œìš© ë¶€ì¡± (ì£¼ê´€ì  ìš”êµ¬ì— ì˜ì¡´)'}
                    </li>
                    <li>
                        <strong>ì´ ì „ëµ í™œìš©:</strong> ì´ ì „ëµ ë³´ë„ˆìŠ¤ ${strategyBonus}ì  íšë“ (ì´ ${gameState.turn}íšŒ ì‹œë„).
                    </li>
                </ul>
            `;
            
            document.getElementById('result-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('result-modal').classList.add('hidden');
        }

        // ì´ˆê¸° ì‹œì‘ ì‹œ, ì„¤ì • í™”ë©´ì˜ ê¸°ë³¸ê°’ì„ ì±„ì›Œ ë„£ìŠµë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => {
            // ê¸°ë³¸ê°’ ì„¤ì •ì€ HTML ë‚´ë¶€ì— ì´ë¯¸ ì™„ë£Œë¨.
        });

    </script>
</body>
</html>
